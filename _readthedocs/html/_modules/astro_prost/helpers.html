

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>astro_prost.helpers &mdash; prost 0.1.dev0+d20241012 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8e33e34d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=d07363f3"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            prost
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks.html">Notebooks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">prost</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">astro_prost.helpers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for astro_prost.helpers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">dl</span> <span class="kn">import</span> <span class="n">queryClient</span> <span class="k">as</span> <span class="n">qC</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">halfnorm</span><span class="p">,</span> <span class="n">norm</span>

<span class="kn">from</span> <span class="nn">.photoz_helpers</span> <span class="kn">import</span> <span class="n">evaluate</span><span class="p">,</span> <span class="n">load_lupton_model</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">,</span> <span class="n">ps1metadata</span>


<div class="viewcode-block" id="GalaxyCatalog">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.GalaxyCatalog">[docs]</a>
<span class="k">class</span> <span class="nc">GalaxyCatalog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : type</span>
<span class="sd">        Description of parameter `name`.</span>
<span class="sd">    data : type</span>
<span class="sd">        Description of parameter `data`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name</span>
<span class="sd">    data</span>
<span class="sd">    n_samples</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<div class="viewcode-block" id="GalaxyCatalog.name">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.GalaxyCatalog.name">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="GalaxyCatalog.data">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.GalaxyCatalog.data">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="GalaxyCatalog.n_samples">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.GalaxyCatalog.n_samples">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span></div>


<div class="viewcode-block" id="GalaxyCatalog.get_candidates">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.GalaxyCatalog.get_candidates">[docs]</a>
    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transient</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">timequery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transient : type</span>
<span class="sd">            Description of parameter `transient`.</span>
<span class="sd">        cosmo : type</span>
<span class="sd">            Description of parameter `cosmo`.</span>
<span class="sd">        timequery : type</span>
<span class="sd">            Description of parameter `timequery`.</span>
<span class="sd">        verbose : type</span>
<span class="sd">            Description of parameter `verbose`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">search_rad</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">300</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transient</span><span class="o">.</span><span class="n">redshift</span> <span class="o">==</span> <span class="n">transient</span><span class="o">.</span><span class="n">redshift</span><span class="p">:</span>
            <span class="n">search_rad</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="mi">100</span> <span class="o">/</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">angular_diameter_distance</span><span class="p">(</span><span class="n">transient</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mi">206265</span><span class="p">,</span>
                        <span class="n">search_rad</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_rad</span> <span class="o">=</span> <span class="n">search_rad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_pos</span> <span class="o">=</span> <span class="n">transient</span><span class="o">.</span><span class="n">position</span>
        <span class="k">if</span> <span class="n">timequery</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;panstarrs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlim</span> <span class="o">=</span> <span class="mi">26</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span> <span class="o">=</span> <span class="n">build_panstarrs_candidates</span><span class="p">(</span>
                <span class="n">transient</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">transient</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                <span class="n">search_rad</span><span class="p">,</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                <span class="n">glade_catalog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;decals&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlim</span> <span class="o">=</span> <span class="mi">26</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span> <span class="o">=</span> <span class="n">build_decals_candidates</span><span class="p">(</span>
                <span class="n">transient</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">transient</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                <span class="n">search_rad</span><span class="p">,</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;glade&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlim</span> <span class="o">=</span> <span class="mi">17</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span> <span class="o">=</span> <span class="n">build_glade_candidates</span><span class="p">(</span>
                    <span class="n">transient</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">transient</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                    <span class="n">search_rad</span><span class="o">=</span><span class="n">search_rad</span><span class="p">,</span>
                    <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                    <span class="n">glade_catalog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Please provide GLADE catalog as &#39;data&#39; when initializing GalaxyCatalog object.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">galaxies</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timequery</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_time</span> <span class="o">=</span> <span class="n">elapsed</span></div>
</div>



<div class="viewcode-block" id="Transient">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient">[docs]</a>
<span class="k">class</span> <span class="nc">Transient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : type</span>
<span class="sd">        Description of parameter `name`.</span>
<span class="sd">    position : type</span>
<span class="sd">        Description of parameter `position`.</span>
<span class="sd">    redshift : type</span>
<span class="sd">        Description of parameter `redshift`.</span>
<span class="sd">    spec_class : type</span>
<span class="sd">        Description of parameter `spec_class`.</span>
<span class="sd">    phot_class : type</span>
<span class="sd">        Description of parameter `phot_class`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    best_host : type</span>
<span class="sd">        Description of attribute `best_host`.</span>
<span class="sd">    second_best_host : type</span>
<span class="sd">        Description of attribute `second_best_host`.</span>
<span class="sd">    redshift_std : type</span>
<span class="sd">        Description of attribute `redshift_std`.</span>
<span class="sd">    gen_z_samples : type</span>
<span class="sd">        Description of attribute `gen_z_samples`.</span>
<span class="sd">    priors : type</span>
<span class="sd">        Description of attribute `priors`.</span>
<span class="sd">    likes : type</span>
<span class="sd">        Description of attribute `likes`.</span>
<span class="sd">    name</span>
<span class="sd">    position</span>
<span class="sd">    redshift</span>
<span class="sd">    spec_class</span>
<span class="sd">    phot_class</span>
<span class="sd">    n_samples</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">spec_class</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">phot_class</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<div class="viewcode-block" id="Transient.name">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.name">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Transient.position">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.position">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span></div>

<div class="viewcode-block" id="Transient.redshift">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.redshift">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">redshift</span></div>

<div class="viewcode-block" id="Transient.spec_class">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.spec_class">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_class</span> <span class="o">=</span> <span class="n">spec_class</span></div>

<div class="viewcode-block" id="Transient.phot_class">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.phot_class">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot_class</span> <span class="o">=</span> <span class="n">phot_class</span></div>

<div class="viewcode-block" id="Transient.n_samples">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.n_samples">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span></div>

<div class="viewcode-block" id="Transient.best_host">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.best_host">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_host</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="Transient.second_best_host">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.second_best_host">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_best_host</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


        <span class="k">if</span> <span class="n">redshift</span> <span class="o">==</span> <span class="n">redshift</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_z_samples</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<div class="viewcode-block" id="Transient.priors">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.priors">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Transient.likes">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.likes">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">likes</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Transient.__str__">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define what should be shown when printing the Transient object</span>
        <span class="n">redshift_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;redshift=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;redshift=N/A&quot;</span>
        <span class="n">class_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;spec. class = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_class</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_class</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;phot. class = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phot_class</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phot_class</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="s2">&quot;unclassified&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Transient(name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, position=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">redshift_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">class_str</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Transient.get_prior">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.get_prior">[docs]</a>
    <span class="k">def</span> <span class="nf">get_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : type</span>
<span class="sd">            Description of parameter `type`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: No prior set for </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">prior</span></div>


<div class="viewcode-block" id="Transient.get_likelihood">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.get_likelihood">[docs]</a>
    <span class="k">def</span> <span class="nf">get_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : type</span>
<span class="sd">            Description of parameter `type`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">like</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likes</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: No likelihood set for </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">like</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">like</span></div>


<div class="viewcode-block" id="Transient.set_likelihood">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.set_likelihood">[docs]</a>
    <span class="k">def</span> <span class="nf">set_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : type</span>
<span class="sd">            Description of parameter `type`.</span>
<span class="sd">        func : type</span>
<span class="sd">            Description of parameter `func`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likes</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span></div>


<div class="viewcode-block" id="Transient.set_prior">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.set_prior">[docs]</a>
    <span class="k">def</span> <span class="nf">set_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : type</span>
<span class="sd">            Description of parameter `type`.</span>
<span class="sd">        func : type</span>
<span class="sd">            Description of parameter `func`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;redshift&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_z_samples</span><span class="p">()</span></div>


<div class="viewcode-block" id="Transient.gen_z_samples">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.gen_z_samples">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_z_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ret : type</span>
<span class="sd">            Description of parameter `ret`.</span>
<span class="sd">        n_samples : type</span>
<span class="sd">            Description of parameter `n_samples`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prior</span><span class="p">(</span><span class="s2">&quot;redshift&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="c1"># now generate distances</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift_samples</span> <span class="o">=</span> <span class="n">samples</span></div>


<div class="viewcode-block" id="Transient.calc_prior_redshift">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_prior_redshift">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_prior_redshift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_best_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z_best_samples : type</span>
<span class="sd">            Description of parameter `z_best_samples`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prior</span><span class="p">(</span><span class="s2">&quot;redshift&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Resulting shape: (n_galaxies,)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pdf</span></div>


<div class="viewcode-block" id="Transient.calc_prior_offset">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_prior_offset">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_prior_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fractional_offset_samples : type</span>
<span class="sd">            Description of parameter `fractional_offset_samples`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prior</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Resulting shape: (n_galaxies,)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pdf</span></div>


<div class="viewcode-block" id="Transient.calc_prior_absmag">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_prior_absmag">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_prior_absmag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        absmag_samples : type</span>
<span class="sd">            Description of parameter `absmag_samples`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prior</span><span class="p">(</span><span class="s2">&quot;absmag&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pdf</span></div>


<div class="viewcode-block" id="Transient.calc_like_redshift">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_like_redshift">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_like_redshift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_best_mean</span><span class="p">,</span> <span class="n">z_best_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z_best_mean : type</span>
<span class="sd">            Description of parameter `z_best_mean`.</span>
<span class="sd">        z_best_std : type</span>
<span class="sd">            Description of parameter `z_best_std`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z_sn_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift_samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (n_sn_samples, 1)</span>
        <span class="n">z_gal_mean</span> <span class="o">=</span> <span class="n">z_best_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (1, n_galaxies)</span>
        <span class="n">z_gal_std</span> <span class="o">=</span> <span class="n">z_best_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (1, n_galaxies)</span>

        <span class="c1"># Calculate the likelihood of each SN redshift sample across each galaxy</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span>
            <span class="n">z_sn_samples</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">z_gal_mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_gal_std</span>
        <span class="p">)</span>  <span class="c1"># Shape: (n_sn_samples, n_galaxies)</span>

        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Resulting shape: (n_galaxies,)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">likelihoods</span></div>


<div class="viewcode-block" id="Transient.calc_like_offset">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_like_offset">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_like_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fractional_offset_samples : type</span>
<span class="sd">            Description of parameter `fractional_offset_samples`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_likelihood</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Resulting shape: (n_galaxies,)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">likelihoods</span></div>


<div class="viewcode-block" id="Transient.calc_like_absmag">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.calc_like_absmag">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_like_absmag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        absmag_samples : type</span>
<span class="sd">            Description of parameter `absmag_samples`.</span>
<span class="sd">        reduce : type</span>
<span class="sd">            Description of parameter `reduce`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assuming a typical 0.1 SN/century/10^10 Lsol (in K-band)</span>
        <span class="c1"># TODO -- convert to K-band luminosity of the host!</span>
        <span class="c1"># https://www.aanda.org/articles/aa/pdf/2005/15/aa1411.pdf</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_likelihood</span><span class="p">(</span><span class="s2">&quot;absmag&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Resulting shape: (n_galaxies,)</span>
        <span class="k">elif</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">likelihoods</span></div>


<div class="viewcode-block" id="Transient.associate">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.associate">[docs]</a>
    <span class="k">def</span> <span class="nf">associate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_catalog</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        galaxy_catalog : type</span>
<span class="sd">            Description of parameter `galaxy_catalog`.</span>
<span class="sd">        cosmo : type</span>
<span class="sd">            Description of parameter `cosmo`.</span>
<span class="sd">        verbose : type</span>
<span class="sd">            Description of parameter `verbose`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngals</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">ngals</span>
        <span class="n">search_rad</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">search_rad</span>
        <span class="n">mlim</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">mlim</span>
        <span class="n">galaxies</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">galaxies</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">n_samples</span>

        <span class="c1"># Extract arrays for all galaxies from the catalog</span>
        <span class="n">z_gal_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">])</span>
        <span class="n">z_gal_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">])</span>
        <span class="n">offset_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">])</span>

        <span class="n">z_gal_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">])</span>
        <span class="n">galaxy_dlr_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">])</span>
        <span class="n">absmag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">])</span>
        <span class="c1"># galaxy_ras = galaxies[&#39;ra&#39;]</span>
        <span class="c1"># galaxy_decs = galaxies[&#39;dec&#39;]</span>

        <span class="c1"># just copied now assuming 0 positional uncertainty -- this can be updated later (TODO!)</span>
        <span class="n">offset_arcsec_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">offset_arcsec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">prior_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_redshift</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_redshift</span><span class="p">(</span><span class="n">z_gal_mean</span><span class="p">,</span> <span class="n">z_gal_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">):</span>
            <span class="c1"># Marginalize over the sampled supernova redshifts</span>
            <span class="c1"># by integrating the likelihood over the redshift prior</span>
            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_z_gal_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_integrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Perform integration using simps or trapz</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sorted_integrand</span><span class="p">,</span> <span class="n">sorted_z_gal_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">p_z</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span>

        <span class="c1"># depends on zgal, NOT zSN</span>
        <span class="n">prior_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Calculate angular diameter distances for all samples</span>
        <span class="n">fractional_offset_samples</span> <span class="o">=</span> <span class="n">offset_arcsec_samples</span> <span class="o">/</span> <span class="n">galaxy_dlr_samples</span>

        <span class="n">prior_offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Shape (N,)</span>
        <span class="c1"># Compute the posterior probabilities for all galaxies</span>
        <span class="n">p_gals</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">prior_offsets</span> <span class="o">*</span> <span class="n">l_offsets</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">prior_absmag</span> <span class="o">*</span> <span class="n">l_absmag</span><span class="p">)</span>

        <span class="c1"># other probabilities</span>
        <span class="n">p_hostless</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_samples</span>
        <span class="p">)</span>  <span class="c1"># some very low value that the SN is actually hostless, across all samples.</span>
        <span class="n">p_outside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability_host_outside_cone</span><span class="p">(</span><span class="n">search_rad</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">)</span>
        <span class="n">p_unobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability_of_unobserved_host</span><span class="p">(</span><span class="n">search_rad</span><span class="p">,</span> <span class="n">mlim</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">)</span>

        <span class="c1"># sum across all galaxies for these overall metrics</span>
        <span class="n">p_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_gals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_hostless</span> <span class="o">+</span> <span class="n">p_outside</span> <span class="o">+</span> <span class="n">p_unobs</span>

        <span class="c1"># floor to machine precision</span>
        <span class="n">p_tot</span><span class="p">[</span><span class="n">p_tot</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

        <span class="n">p_none_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_outside</span> <span class="o">+</span> <span class="n">p_hostless</span> <span class="o">+</span> <span class="n">p_unobs</span><span class="p">)</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_any_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_gals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">p_tot</span>

        <span class="n">p_gals_norm</span> <span class="o">=</span> <span class="n">p_gals</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_offsets_norm</span> <span class="o">=</span> <span class="n">prior_offsets</span> <span class="o">*</span> <span class="n">l_offsets</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_z_norm</span> <span class="o">=</span> <span class="n">p_z</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_absmag_norm</span> <span class="o">=</span> <span class="n">prior_absmag</span> <span class="o">*</span> <span class="n">l_absmag</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_outside_norm</span> <span class="o">=</span> <span class="n">p_outside</span> <span class="o">/</span> <span class="n">p_tot</span>
        <span class="n">p_unobs_norm</span> <span class="o">=</span> <span class="n">p_unobs</span> <span class="o">/</span> <span class="n">p_tot</span>

        <span class="c1"># Sort and get last 2 indices in descending order</span>
        <span class="n">top_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_gals_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">associated_catalog</span> <span class="o">=</span> <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">any_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_any_norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">none_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_none_norm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">any_prob</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">none_prob</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Association successful!&quot;</span><span class="p">)</span>
            <span class="c1"># get best and second-best matches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_host</span> <span class="o">=</span> <span class="n">top_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ngals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">second_best_host</span> <span class="o">=</span> <span class="n">top_idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_host</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">second_best_host</span> <span class="o">=</span> <span class="n">top_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># set best host as second-best -- best is no host</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_outside_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_unobs_norm</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Association failed. Host is likely outside search cone.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Association failed. Host is likely missing from the catalog.&quot;</span><span class="p">)</span>

        <span class="c1"># consolidate across samples</span>
        <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_z_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;offset_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_offsets_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;absmag_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_absmag_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">galaxy_catalog</span><span class="o">.</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;total_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">p_gals_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">galaxy_catalog</span></div>


<div class="viewcode-block" id="Transient.probability_of_unobserved_host">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.probability_of_unobserved_host">[docs]</a>
    <span class="k">def</span> <span class="nf">probability_of_unobserved_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_rad</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">m_lim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        search_rad : type</span>
<span class="sd">            Description of parameter `search_rad`.</span>
<span class="sd">        m_lim : type</span>
<span class="sd">            Description of parameter `m_lim`.</span>
<span class="sd">        verbose : type</span>
<span class="sd">            Description of parameter `verbose`.</span>
<span class="sd">        n_samples : type</span>
<span class="sd">            Description of parameter `n_samples`.</span>
<span class="sd">        cosmo : type</span>
<span class="sd">            Description of parameter `cosmo`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_gals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="n">z_sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span>
        <span class="n">z_sn_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift_std</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_sn</span><span class="p">):</span>
            <span class="c1"># draw galaxies from the same distribution</span>
            <span class="n">z_gal_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_z_samples</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z_gal_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">z_gal_mean</span>
            <span class="n">z_gal_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="mf">0.001</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">z_gal_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_gal_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">prior_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_redshift</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">l_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_redshift</span><span class="p">(</span><span class="n">z_gal_mean</span><span class="p">,</span> <span class="n">z_gal_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_z_gal_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">z_gal_samples</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_integrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Perform integration using simps or trapz</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sorted_integrand</span><span class="p">,</span> <span class="n">sorted_z_gal_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">p_z</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (n_galaxies, 1)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the known supernova redshift</span>
            <span class="n">z_best_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">z_sn</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">z_sn_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">)))</span>
            <span class="n">z_best_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">z_best_mean</span>  <span class="c1"># assume all well-constrained redshifts</span>
            <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="mf">0.001</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">z_best_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_best_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">prior_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_redshift</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">l_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_redshift</span><span class="p">(</span><span class="n">z_best_mean</span><span class="p">,</span> <span class="n">z_best_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span>

        <span class="n">galaxy_physical_radius_prior_means</span> <span class="o">=</span> <span class="n">halfnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># in kpc</span>
        <span class="n">galaxy_physical_radius_prior_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">galaxy_physical_radius_prior_means</span>
        <span class="n">galaxy_physical_radius_prior_samples</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">galaxy_physical_radius_prior_means</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">galaxy_physical_radius_prior_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">sn_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># in pc</span>

        <span class="n">min_phys_rad</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">max_phys_rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">search_rad</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="mi">206265</span><span class="p">)</span> <span class="o">*</span> <span class="n">sn_distance</span> <span class="o">/</span> <span class="mf">1.0e3</span>  <span class="c1"># in kpc</span>

        <span class="n">physical_offset_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_phys_rad</span><span class="p">,</span> <span class="n">max_phys_rad</span><span class="p">,</span> <span class="n">n_gals</span><span class="p">)</span>
        <span class="n">physical_offset_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">physical_offset_mean</span>

        <span class="n">physical_offset_samples</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">physical_offset_mean</span><span class="p">,</span> <span class="n">physical_offset_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">fractional_offset_samples</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">physical_offset_samples</span> <span class="o">/</span> <span class="n">galaxy_physical_radius_prior_samples</span>
        <span class="p">)</span>  <span class="c1"># Shape: (n_samples, n_samples)</span>

        <span class="n">prior_offset_unobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_offset_unobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">absmag_lim_samples</span> <span class="o">=</span> <span class="n">m_lim</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sn_distance</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>

        <span class="n">absmag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">absmag_lim_samples</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_gals</span><span class="p">)</span>

        <span class="n">prior_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">prob_unobs</span> <span class="o">=</span> <span class="n">prior_absmag</span> <span class="o">*</span> <span class="n">l_absmag</span> <span class="o">*</span> <span class="n">p_z</span> <span class="o">*</span> <span class="n">prior_offset_unobs</span> <span class="o">*</span> <span class="n">l_offset_unobs</span>

        <span class="n">p_unobserved</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">prob_unobs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># average over all galaxies</span>

        <span class="k">return</span> <span class="n">p_unobserved</span></div>


<div class="viewcode-block" id="Transient.probability_host_outside_cone">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.Transient.probability_host_outside_cone">[docs]</a>
    <span class="k">def</span> <span class="nf">probability_host_outside_cone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">cutout_rad</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutout_rad : type</span>
<span class="sd">            Description of parameter `cutout_rad`.</span>
<span class="sd">        verbose : type</span>
<span class="sd">            Description of parameter `verbose`.</span>
<span class="sd">        n_samples : type</span>
<span class="sd">            Description of parameter `n_samples`.</span>
<span class="sd">        cosmo : type</span>
<span class="sd">            Description of parameter `cosmo`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_gals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">z_sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span>
        <span class="n">z_sn_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift_std</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_sn</span><span class="p">):</span>
            <span class="c1"># draw galaxies from the same distribution</span>
            <span class="n">z_best_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_z_samples</span><span class="p">(</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>  <span class="c1"># draw from prior if redshift is missing</span>
            <span class="n">z_best_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">z_best_mean</span>

            <span class="c1"># scatter around some nominal uncertainty</span>
            <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="mf">0.001</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">z_best_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_best_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">prior_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_redshift</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">l_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_redshift</span><span class="p">(</span><span class="n">z_best_mean</span><span class="p">,</span> <span class="n">z_best_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_z_best_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_integrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Perform integration using trapezoidal integration</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sorted_integrand</span><span class="p">,</span> <span class="n">sorted_z_best_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p_z</span> <span class="o">=</span> <span class="n">p_z</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the known supernova redshift</span>
            <span class="c1"># z_sn_std = 0.05 * z_sn</span>
            <span class="c1"># z_sn_samples = np.maximum(0.001, norm.rvs(z_sn, z_sn_std, size=n_samples))</span>
            <span class="c1"># some higher spread for host redshift photo-zs</span>
            <span class="n">z_best_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">z_sn</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">z_sn_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">)))</span>
            <span class="n">z_best_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">z_best_mean</span>  <span class="c1"># assume all well-constrained redshifts</span>
            <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="mf">0.001</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">z_best_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_best_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">prior_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_redshift</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">l_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_redshift</span><span class="p">(</span><span class="n">z_best_mean</span><span class="p">,</span> <span class="n">z_best_std</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">p_z</span> <span class="o">=</span> <span class="n">prior_z</span> <span class="o">*</span> <span class="n">l_z</span>

        <span class="c1"># sample brightnesses</span>
        <span class="n">absmag_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prior</span><span class="p">(</span><span class="s2">&quot;absmag&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_gals</span><span class="p">)</span>
        <span class="n">absmag_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">absmag_mean</span><span class="p">)</span>

        <span class="n">absmag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="mf">0.001</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">absmag_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">absmag_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">prior_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Calculate the distance to the supernova for each sampled redshift</span>
        <span class="n">sn_distances</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">comoving_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift_samples</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># in Mpc</span>

        <span class="c1"># Convert angular cutout radius to physical offset at each sampled redshift</span>
        <span class="n">min_phys_rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">cutout_rad</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="mi">206265</span><span class="p">)</span> <span class="o">*</span> <span class="n">sn_distances</span> <span class="o">*</span> <span class="mf">1e3</span>  <span class="c1"># in kpc</span>
        <span class="n">max_phys_rad</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">min_phys_rad</span>

        <span class="n">galaxy_physical_radius_prior_means</span> <span class="o">=</span> <span class="n">halfnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># in kpc</span>
        <span class="n">galaxy_physical_radius_prior_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">galaxy_physical_radius_prior_means</span>
        <span class="n">galaxy_physical_radius_prior_samples</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">galaxy_physical_radius_prior_means</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">galaxy_physical_radius_prior_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">physical_offset_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_phys_rad</span><span class="p">,</span> <span class="n">max_phys_rad</span><span class="p">,</span> <span class="n">n_gals</span><span class="p">)</span>
        <span class="n">fractional_offset_samples</span> <span class="o">=</span> <span class="n">physical_offset_samples</span> <span class="o">/</span> <span class="n">galaxy_physical_radius_prior_samples</span>

        <span class="n">prior_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_prior_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_offset</span><span class="p">(</span><span class="n">fractional_offset_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">l_absmag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_like_absmag</span><span class="p">(</span><span class="n">absmag_samples</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">prob_outside</span> <span class="o">=</span> <span class="n">prior_absmag</span> <span class="o">*</span> <span class="n">l_absmag</span> <span class="o">*</span> <span class="n">p_z</span> <span class="o">*</span> <span class="n">prior_offset</span> <span class="o">*</span> <span class="n">l_offset</span>

        <span class="c1"># average over all simulated galaxies -- keep the sample</span>
        <span class="n">p_outside</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">prob_outside</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p_outside</span></div>
</div>



<div class="viewcode-block" id="PriorzObservedTransients">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients">[docs]</a>
<span class="k">class</span> <span class="nc">PriorzObservedTransients</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z_min : type</span>
<span class="sd">        Description of parameter `z_min`.</span>
<span class="sd">    z_max : type</span>
<span class="sd">        Description of parameter `z_max`.</span>
<span class="sd">    n_bins : type</span>
<span class="sd">        Description of parameter `n_bins`.</span>
<span class="sd">    mag_cutoff : type</span>
<span class="sd">        Description of parameter `mag_cutoff`.</span>
<span class="sd">    absmag_mean : type</span>
<span class="sd">        Description of parameter `absmag_mean`.</span>
<span class="sd">    absmag_min : type</span>
<span class="sd">        Description of parameter `absmag_min`.</span>
<span class="sd">    absmag_max : type</span>
<span class="sd">        Description of parameter `absmag_max`.</span>
<span class="sd">    r_sn : type</span>
<span class="sd">        Description of parameter `r_sn`.</span>
<span class="sd">    t_obs : type</span>
<span class="sd">        Description of parameter `t_obs`.</span>
<span class="sd">    **kwargs : type</span>
<span class="sd">        Description of parameter `**kwargs`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cosmo : type</span>
<span class="sd">        Description of attribute `cosmo`.</span>
<span class="sd">    _generate_distribution : type</span>
<span class="sd">        Description of attribute `_generate_distribution`.</span>
<span class="sd">    z_min</span>
<span class="sd">    z_max</span>
<span class="sd">    n_bins</span>
<span class="sd">    mag_cutoff</span>
<span class="sd">    absmag_mean</span>
<span class="sd">    absmag_min</span>
<span class="sd">    absmag_max</span>
<span class="sd">    r_sn</span>
<span class="sd">    t_obs</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="p">,</span>
        <span class="n">z_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">z_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">mag_cutoff</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
        <span class="n">absmag_mean</span><span class="o">=-</span><span class="mi">19</span><span class="p">,</span>
        <span class="n">absmag_min</span><span class="o">=-</span><span class="mi">24</span><span class="p">,</span>
        <span class="n">absmag_max</span><span class="o">=-</span><span class="mi">17</span><span class="p">,</span>
        <span class="n">r_sn</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">t_obs</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Assign the parameters</span>
<div class="viewcode-block" id="PriorzObservedTransients.z_min">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.z_min">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">=</span> <span class="n">z_min</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.z_max">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.z_max">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="n">z_max</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.n_bins">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.n_bins">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.mag_cutoff">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.mag_cutoff">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_cutoff</span> <span class="o">=</span> <span class="n">mag_cutoff</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.absmag_mean">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.absmag_mean">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">absmag_mean</span> <span class="o">=</span> <span class="n">absmag_mean</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.absmag_min">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.absmag_min">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">absmag_min</span> <span class="o">=</span> <span class="n">absmag_min</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.absmag_max">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.absmag_max">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">absmag_max</span> <span class="o">=</span> <span class="n">absmag_max</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.r_sn">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.r_sn">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_sn</span> <span class="o">=</span> <span class="n">r_sn</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.t_obs">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.t_obs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_obs</span> <span class="o">=</span> <span class="n">t_obs</span></div>

<div class="viewcode-block" id="PriorzObservedTransients.cosmo">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.cosmo">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmo</span></div>


        <span class="c1"># Automatically run the internal function to generate the distribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_distribution</span><span class="p">()</span>

<div class="viewcode-block" id="PriorzObservedTransients._generate_distribution">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients._generate_distribution">[docs]</a>
    <span class="k">def</span> <span class="nf">_generate_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create redshift bins</span>
        <span class="n">z_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">z_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">z_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># Centers of redshift bins</span>

        <span class="c1"># Calculate the comoving volume element dV/dz for each redshift bin</span>
        <span class="n">dv_dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">differential_comoving_volume</span><span class="p">(</span><span class="n">z_centers</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># in Mpc^3 per steradian per dz</span>

        <span class="c1"># Full sky solid angle (4 pi steradians)</span>
        <span class="n">solid_angle</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># full sky in steradians</span>

        <span class="c1"># Supernovae per redshift bin (for full sky)</span>
        <span class="n">supernovae_per_bin</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_sn</span> <span class="o">*</span> <span class="n">dv_dz</span> <span class="o">*</span> <span class="n">solid_angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z_bins</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Generate random redshifts for all supernovae</span>
        <span class="n">z_scattered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">z_bins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z_bins</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">supernovae_per_bin</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Calculate luminosity distance (in parsecs) for all supernovae</span>
        <span class="n">d_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">z_scattered</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Sample absolute magnitudes from a Gaussian and clip the values to the range [Mmin, Mmax]</span>
        <span class="n">absolute_magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absmag_mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">z_scattered</span><span class="p">))</span>
        <span class="n">absolute_magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">absolute_magnitudes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">absmag_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">absmag_max</span><span class="p">)</span>

        <span class="c1"># Calculate apparent magnitudes using distance modulus for all supernovae</span>
        <span class="n">m_apparent</span> <span class="o">=</span> <span class="n">absolute_magnitudes</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">d_l</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Filter supernovae based on apparent magnitude cutoff</span>
        <span class="n">observed_indices</span> <span class="o">=</span> <span class="n">m_apparent</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observed_redshifts</span> <span class="o">=</span> <span class="n">z_scattered</span><span class="p">[</span><span class="n">observed_indices</span><span class="p">]</span>

        <span class="c1"># Calculate the best fit KDE for observed redshifts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bestFit</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observed_redshifts</span><span class="p">)</span></div>


<div class="viewcode-block" id="PriorzObservedTransients.pdf">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.pdf">[docs]</a>
    <span class="k">def</span> <span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the PDF (KDE) based on observed redshifts.</span>
<span class="sd">        Handles 1D and 2D arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">flat_z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">flat_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestFit</span><span class="p">(</span><span class="n">flat_z</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flat_pdf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestFit</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>


<div class="viewcode-block" id="PriorzObservedTransients.rvs">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.rvs">[docs]</a>
    <span class="k">def</span> <span class="nf">rvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size : type</span>
<span class="sd">            Description of parameter `size`.</span>
<span class="sd">        random_state : type</span>
<span class="sd">            Description of parameter `random_state`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestFit</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="PriorzObservedTransients.plot">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.PriorzObservedTransients.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observed_redshifts</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">z_bins</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed Histogram&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Redshift (z)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the KDE over a fine grid of redshift values</span>
        <span class="n">z_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_fine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bestFit</span><span class="p">(</span><span class="n">z_fine</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KDE Fit&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Observed Supernovae with $m &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_cutoff</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="SnRateAbsmag">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.SnRateAbsmag">[docs]</a>
<span class="k">class</span> <span class="nc">SnRateAbsmag</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : type</span>
<span class="sd">        Description of parameter `a`.</span>
<span class="sd">    b : type</span>
<span class="sd">        Description of parameter `b`.</span>
<span class="sd">    **kwargs : type</span>
<span class="sd">        Description of parameter `**kwargs`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    normalization : type</span>
<span class="sd">        Description of attribute `normalization`.</span>
<span class="sd">    _calculate_normalization : type</span>
<span class="sd">        Description of attribute `_calculate_normalization`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="SnRateAbsmag.normalization">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.SnRateAbsmag.normalization">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_normalization</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="SnRateAbsmag._calculate_normalization">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.SnRateAbsmag._calculate_normalization">[docs]</a>
    <span class="k">def</span> <span class="nf">_calculate_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : type</span>
<span class="sd">            Description of parameter `a`.</span>
<span class="sd">        b : type</span>
<span class="sd">            Description of parameter `b`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unnormalized_pdf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SnRateAbsmag._unnormalized_pdf">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.SnRateAbsmag._unnormalized_pdf">[docs]</a>
    <span class="k">def</span> <span class="nf">_unnormalized_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abs_mag_samples</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        abs_mag_samples : type</span>
<span class="sd">            Description of parameter `abs_mag_samples`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msol</span> <span class="o">=</span> <span class="mf">4.74</span>
        <span class="n">lgal</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.4</span> <span class="o">*</span> <span class="p">(</span><span class="n">abs_mag_samples</span> <span class="o">-</span> <span class="n">msol</span><span class="p">))</span>  <span class="c1"># in units of Lsol</span>
        <span class="n">lgal</span> <span class="o">/=</span> <span class="mf">1.0e10</span>  <span class="c1"># in units of 10^10 Lsol</span>
        <span class="n">snrate</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">lgal</span>
        <span class="k">return</span> <span class="n">snrate</span></div>


<div class="viewcode-block" id="SnRateAbsmag._pdf">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.SnRateAbsmag._pdf">[docs]</a>
    <span class="k">def</span> <span class="nf">_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_abs_samples</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m_abs_samples : type</span>
<span class="sd">            Description of parameter `m_abs_samples`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unnormalized_pdf</span><span class="p">(</span><span class="n">m_abs_samples</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span></div>
</div>



<span class="c1"># from https://ps1images.stsci.edu/ps1_dr2_api.html</span>
<div class="viewcode-block" id="ps1cone">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.ps1cone">[docs]</a>
<span class="k">def</span> <span class="nf">ps1cone</span><span class="p">(</span>
    <span class="n">ra</span><span class="p">,</span>
    <span class="n">dec</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">,</span>
    <span class="n">table</span><span class="o">=</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s2">&quot;dr2&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">baseurl</span><span class="o">=</span><span class="s2">&quot;https://catalogs.mast.stsci.edu/api/v0.1/panstarrs&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra : type</span>
<span class="sd">        Description of parameter `ra`.</span>
<span class="sd">    dec : type</span>
<span class="sd">        Description of parameter `dec`.</span>
<span class="sd">    radius : type</span>
<span class="sd">        Description of parameter `radius`.</span>
<span class="sd">    table : type</span>
<span class="sd">        Description of parameter `table`.</span>
<span class="sd">    release : type</span>
<span class="sd">        Description of parameter `release`.</span>
<span class="sd">    format : type</span>
<span class="sd">        Description of parameter `format`.</span>
<span class="sd">    columns : type</span>
<span class="sd">        Description of parameter `columns`.</span>
<span class="sd">    baseurl : type</span>
<span class="sd">        Description of parameter `baseurl`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>
<span class="sd">    **kw : type</span>
<span class="sd">        Description of parameter `**kw`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
    <span class="k">return</span> <span class="n">ps1search</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="n">release</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">baseurl</span><span class="o">=</span><span class="n">baseurl</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="ps1search">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.ps1search">[docs]</a>
<span class="k">def</span> <span class="nf">ps1search</span><span class="p">(</span>
    <span class="n">table</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s2">&quot;dr1&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">baseurl</span><span class="o">=</span><span class="s2">&quot;https://catalogs.mast.stsci.edu/api/v0.1/panstarrs&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table : type</span>
<span class="sd">        Description of parameter `table`.</span>
<span class="sd">    release : type</span>
<span class="sd">        Description of parameter `release`.</span>
<span class="sd">    format : type</span>
<span class="sd">        Description of parameter `format`.</span>
<span class="sd">    columns : type</span>
<span class="sd">        Description of parameter `columns`.</span>
<span class="sd">    baseurl : type</span>
<span class="sd">        Description of parameter `baseurl`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>
<span class="sd">    **kw : type</span>
<span class="sd">        Description of parameter `**kw`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">baseurl</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">dcols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps1metadata</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">release</span><span class="p">)[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="n">dcols</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">badcols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dcols</span><span class="p">:</span>
                <span class="n">badcols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">badcols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some columns not found in table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">badcols</span><span class="p">)))</span>
        <span class="c1"># two different ways to specify a list of column values in the API</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span></div>



<div class="viewcode-block" id="build_glade_candidates">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.build_glade_candidates">[docs]</a>
<span class="k">def</span> <span class="nf">build_glade_candidates</span><span class="p">(</span>
    <span class="n">transient_name</span><span class="p">,</span>
    <span class="n">transient_pos</span><span class="p">,</span>
    <span class="n">glade_catalog</span><span class="p">,</span>
    <span class="n">search_rad</span><span class="p">,</span>
    <span class="n">cosmo</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transient_name : type</span>
<span class="sd">        Description of parameter `transient_name`.</span>
<span class="sd">    transient_pos : type</span>
<span class="sd">        Description of parameter `transient_pos`.</span>
<span class="sd">    glade_catalog : type</span>
<span class="sd">        Description of parameter `glade_catalog`.</span>
<span class="sd">    search_rad : type</span>
<span class="sd">        Description of parameter `search_rad`.</span>
<span class="sd">    cosmo : type</span>
<span class="sd">        Description of parameter `cosmo`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">search_rad</span><span class="p">:</span>
        <span class="n">search_rad</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">glade_catalog</span><span class="p">[</span>
        <span class="n">SkyCoord</span><span class="p">(</span><span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">transient_pos</span><span class="p">)</span>
        <span class="o">.</span><span class="n">arcsec</span>
        <span class="o">&lt;</span> <span class="n">search_rad</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="p">]</span>
    <span class="n">n_galaxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_galaxies</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># print(f&quot;No sources found around {transient_name} in GLADE!&quot;)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">temp_pa</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;PAHyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_pa</span><span class="p">[</span><span class="n">temp_pa</span> <span class="o">!=</span> <span class="n">temp_pa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># assume no position angle for unmeasured gals</span>

    <span class="c1"># (n) HyperLEDA decimal logarithm of the length of the projected major axis</span>
    <span class="c1"># of a galaxy at the isophotal level 25mag/arcsec2 in the B-band,</span>
    <span class="c1"># to semi-major half-axis (half-light radius) in arcsec</span>
    <span class="n">temp_sizes</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;logd25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># 1 pixel, at least for PS1</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
        <span class="n">temp_sizes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;e_logd25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;objID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;total_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">galaxies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># dummy placeholder for IDs</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;objID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">))</span>

    <span class="n">galaxies_pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="p">)</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>

    <span class="c1"># (n) HyperLEDA decimal logarithm of the length of the projected major axis</span>
    <span class="c1"># of a galaxy at the isophotal level 25mag/arcsec2 in the B-band,</span>
    <span class="c1"># to semi-major half-axis (half-light radius) in arcsec</span>
    <span class="n">temp_sizes</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;logd25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># 1 pixel, at least for PS1</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
        <span class="n">temp_sizes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;e_logd25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>

    <span class="n">temp_sizes_std</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">!=</span> <span class="n">temp_sizes_std</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">!=</span> <span class="n">temp_sizes_std</span><span class="p">]</span>
    <span class="n">temp_sizes_std</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span>

    <span class="c1"># Convert distances to corresponding redshift (no sampling yet, just conversion)</span>
    <span class="n">z_best_mean</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;z_best&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">z_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
        <span class="mf">0.001</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">z_best_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">z_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">galaxy_a_over_b</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;logr25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">galaxy_a_over_b_std</span> <span class="o">=</span> <span class="n">galaxy_a_over_b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;e_logr25Hyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># set uncertainty floor</span>
    <span class="n">nanbool</span> <span class="o">=</span> <span class="n">galaxy_a_over_b_std</span> <span class="o">!=</span> <span class="n">galaxy_a_over_b_std</span>
    <span class="n">galaxy_a_over_b_std</span><span class="p">[</span><span class="n">nanbool</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">galaxy_a_over_b</span><span class="p">[</span><span class="n">nanbool</span><span class="p">]</span>

    <span class="n">temp_pa</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;PAHyp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_pa</span><span class="p">[</span><span class="n">temp_pa</span> <span class="o">!=</span> <span class="n">temp_pa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># assume no position angle for unmeasured gals</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">temp_pa</span><span class="p">)</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">phi</span>  <span class="c1"># uncertainty floor</span>

    <span class="n">dlr_samples</span> <span class="o">=</span> <span class="n">calc_dlr</span><span class="p">(</span>
        <span class="n">transient_pos</span><span class="p">,</span>
        <span class="n">galaxies_pos</span><span class="p">,</span>
        <span class="n">temp_sizes</span><span class="p">,</span>
        <span class="n">temp_sizes_std</span><span class="p">,</span>
        <span class="n">galaxy_a_over_b</span><span class="p">,</span>
        <span class="n">galaxy_a_over_b_std</span><span class="p">,</span>
        <span class="n">phi</span><span class="p">,</span>
        <span class="n">phi_std</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">z_best_samples</span><span class="p">[</span><span class="n">z_best_samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>
    <span class="n">z_best_samples</span><span class="p">[</span><span class="n">z_best_samples</span> <span class="o">!=</span> <span class="n">z_best_samples</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>

    <span class="n">temp_mag_r</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;Bmag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_mag_r_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;e_Bmag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># set a floor of 5%</span>
    <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span>

    <span class="n">absmag_samples</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">temp_mag_r</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">temp_mag_r_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_mag_r</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">distmod</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="p">)</span>

    <span class="c1"># Calculate angular separation between SN and all galaxies (in arcseconds)</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">SkyCoord</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">transient_pos</span><span class="p">)</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">):</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_best_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlr_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">absmag_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">galaxies</span></div>



<div class="viewcode-block" id="build_decals_candidates">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.build_decals_candidates">[docs]</a>
<span class="k">def</span> <span class="nf">build_decals_candidates</span><span class="p">(</span><span class="n">transient_name</span><span class="p">,</span> <span class="n">transient_pos</span><span class="p">,</span> <span class="n">search_rad</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transient_name : type</span>
<span class="sd">        Description of parameter `transient_name`.</span>
<span class="sd">    transient_pos : type</span>
<span class="sd">        Description of parameter `transient_pos`.</span>
<span class="sd">    search_rad : type</span>
<span class="sd">        Description of parameter `search_rad`.</span>
<span class="sd">    cosmo : type</span>
<span class="sd">        Description of parameter `cosmo`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">search_rad</span><span class="p">:</span>
        <span class="n">search_rad</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

    <span class="n">rad_deg</span> <span class="o">=</span> <span class="n">search_rad</span><span class="o">.</span><span class="n">deg</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">qC</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">sql</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;SELECT</span>
<span class="s2">        t.ls_id,</span>
<span class="s2">        t.shape_r,</span>
<span class="s2">        t.shape_r_ivar,</span>
<span class="s2">        t.shape_e1,</span>
<span class="s2">        t.shape_e1_ivar,</span>
<span class="s2">        t.shape_e2,</span>
<span class="s2">        t.shape_e2_ivar,</span>
<span class="s2">        t.ra,</span>
<span class="s2">        t.type,</span>
<span class="s2">        t.dec,</span>
<span class="s2">        t.dered_mag_r,</span>
<span class="s2">        t.mag_r,</span>
<span class="s2">        t.flux_r,</span>
<span class="s2">        t.flux_ivar_r,</span>
<span class="s2">        t.nobs_g,</span>
<span class="s2">        t.nobs_r,</span>
<span class="s2">        t.nobs_z,</span>
<span class="s2">        t.fitbits,</span>
<span class="s2">        t.ra_ivar,</span>
<span class="s2">        t.dec_ivar,</span>
<span class="s2">        t.dered_flux_r,</span>
<span class="s2">        pz.z_phot_mean,</span>
<span class="s2">        pz.z_phot_median,</span>
<span class="s2">        pz.z_phot_std,</span>
<span class="s2">        pz.z_spec</span>
<span class="s2">    FROM</span>
<span class="s2">        ls_dr9.tractor t</span>
<span class="s2">    INNER JOIN</span>
<span class="s2">        ls_dr9.photo_z pz</span>
<span class="s2">    ON</span>
<span class="s2">        t.ls_id= pz.ls_id</span>
<span class="s2">    WHERE</span>
<span class="s2">        q3c_radial_query(t.ra, t.dec, </span><span class="si">{</span><span class="n">transient_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">transient_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rad_deg</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    AND (t.nobs_r &gt; 0) AND (t.dered_flux_r &gt; 0) AND (t.snr_r &gt; 0)</span>
<span class="s2">    AND nullif(t.dered_mag_r, &#39;NaN&#39;) is not null AND (t.fitbits != 8192)</span>
<span class="s2">    AND ((pz.z_spec &gt; 0) OR (pz.z_phot_mean &gt; 0))&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

    <span class="n">n_galaxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_galaxies</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No sources found around </span><span class="si">{</span><span class="n">transient_name</span><span class="si">}</span><span class="s2"> in DECaLS!&quot;</span>
                <span class="s2">&quot;Double-check that the transient coords overlap the survey footprint.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;objID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ls_id&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;total_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">galaxies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">galaxies_pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;objID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;ls_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>

    <span class="n">temp_sizes</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># 1 pixel, at least for PS1</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_r_ivar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">temp_sizes_std</span><span class="p">,</span> <span class="mf">1.0e-10</span><span class="p">)</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">temp_sizes_std</span><span class="p">),</span> <span class="n">temp_sizes</span><span class="p">)</span>

    <span class="n">temp_sizes_std</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">!=</span> <span class="n">temp_sizes_std</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">!=</span> <span class="n">temp_sizes_std</span><span class="p">]</span>
    <span class="n">temp_sizes_std</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span>

    <span class="n">galaxy_photoz_mean</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;z_phot_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">galaxy_photoz_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;z_phot_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">galaxy_specz</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;z_spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">temp_e1</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_e1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_e1_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_e1_ivar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_e1_std</span><span class="p">[</span><span class="n">temp_e1_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e1</span><span class="p">[</span><span class="n">temp_e1_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e1</span><span class="p">]</span>
    <span class="n">temp_e1_std</span><span class="p">[</span><span class="n">temp_e1_std</span> <span class="o">&gt;</span> <span class="mf">1.0e-10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">temp_e1_std</span><span class="p">[</span><span class="n">temp_e1_std</span> <span class="o">&gt;</span> <span class="mf">1.0e-10</span><span class="p">])</span>

    <span class="n">temp_e2</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_e2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_e2_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;shape_e2_ivar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_e2_std</span><span class="p">[</span><span class="n">temp_e2_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e2</span><span class="p">[</span><span class="n">temp_e2_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_e2</span><span class="p">]</span>
    <span class="n">temp_e2_std</span><span class="p">[</span><span class="n">temp_e1_std</span> <span class="o">&gt;</span> <span class="mf">1.0e-10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">temp_e2_std</span><span class="p">[</span><span class="n">temp_e2_std</span> <span class="o">&gt;</span> <span class="mf">1.0e-10</span><span class="p">])</span>

    <span class="c1"># Calculate ellipticity and axis ratio for all samples</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">temp_e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">temp_e2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mf">1.0e-10</span><span class="p">)</span>

    <span class="n">a_over_b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># Compute uncertainty in e (sigma_e)</span>
    <span class="n">e_std</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">temp_e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">temp_e1_std</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">temp_e2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">temp_e2_std</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Compute uncertainty in a_over_b (sigma_a_over_b)</span>
    <span class="n">a_over_b_std</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">e_std</span>

    <span class="c1"># Position angle and angle calculations for all samples</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">temp_e2</span><span class="p">,</span> <span class="n">temp_e1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">denom</span> <span class="o">=</span> <span class="n">temp_e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">temp_e2</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0e-10</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>

    <span class="n">partial_phi_e1</span> <span class="o">=</span> <span class="n">temp_e2</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="n">partial_phi_e2</span> <span class="o">=</span> <span class="o">-</span><span class="n">temp_e1</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="c1"># Propagate uncertainties</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">partial_phi_e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">temp_e1_std</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">partial_phi_e2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">temp_e2_std</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_std</span><span class="p">)</span>
    <span class="n">phi_std</span><span class="p">[</span><span class="n">phi_std</span> <span class="o">!=</span> <span class="n">phi_std</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">phi</span><span class="p">[</span><span class="n">phi_std</span> <span class="o">!=</span> <span class="n">phi_std</span><span class="p">]</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0e-10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">phi_std</span><span class="p">))</span>  <span class="c1"># 5% uncertainty floor</span>

    <span class="n">dlr_samples</span> <span class="o">=</span> <span class="n">calc_dlr</span><span class="p">(</span>
        <span class="n">transient_pos</span><span class="p">,</span> <span class="n">galaxies_pos</span><span class="p">,</span> <span class="n">temp_sizes</span><span class="p">,</span> <span class="n">temp_sizes_std</span><span class="p">,</span> <span class="n">a_over_b</span><span class="p">,</span> <span class="n">a_over_b_std</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">phi_std</span>
    <span class="p">)</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxy_photoz_mean</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">galaxy_photoz_std</span><span class="p">)</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">][</span><span class="n">galaxy_specz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">galaxy_specz</span><span class="p">[</span><span class="n">galaxy_specz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># floor of 5%</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">][</span><span class="n">galaxy_specz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxy_specz</span><span class="p">[</span><span class="n">galaxy_specz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">galaxy_photoz_std</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">galaxy_photoz_mean</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">galaxy_photoz_mean</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">galaxy_photoz_std</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">galaxy_photoz_mean</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># ceiling of 50%</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ls_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;ls_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Calculate angular separation between SN and all galaxies (in arcseconds)</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">SkyCoord</span><span class="p">(</span><span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">transient_pos</span><span class="p">)</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="p">)</span>

    <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>  <span class="c1"># Shape (N, 1) to allow broadcasting</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>  <span class="c1"># Shape (N, 1)</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>  <span class="c1"># Shape (N, M)</span>
    <span class="p">)</span>
    <span class="n">z_best_samples</span><span class="p">[</span><span class="n">z_best_samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>
    <span class="n">z_best_samples</span><span class="p">[</span><span class="n">z_best_samples</span> <span class="o">!=</span> <span class="n">z_best_samples</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>

    <span class="n">temp_mag_r</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;dered_mag_r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">temp_mag_r_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
        <span class="mf">2.5</span>
        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;flux_ivar_r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="o">/</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;flux_r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>

    <span class="c1"># cap at 50% the mag</span>
    <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&gt;</span> <span class="n">temp_mag_r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&gt;</span> <span class="n">temp_mag_r</span><span class="p">]</span>
    <span class="c1"># set a floor of 5%</span>
    <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span>

    <span class="n">absmag_samples</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">temp_mag_r</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">temp_mag_r_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_mag_r</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">distmod</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">):</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_best_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlr_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">absmag_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">galaxies</span></div>



<div class="viewcode-block" id="build_panstarrs_candidates">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.build_panstarrs_candidates">[docs]</a>
<span class="k">def</span> <span class="nf">build_panstarrs_candidates</span><span class="p">(</span>
    <span class="n">transient_name</span><span class="p">,</span>
    <span class="n">transient_pos</span><span class="p">,</span>
    <span class="n">search_rad</span><span class="p">,</span>
    <span class="n">cosmo</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">glade_catalog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transient_name : type</span>
<span class="sd">        Description of parameter `transient_name`.</span>
<span class="sd">    transient_pos : type</span>
<span class="sd">        Description of parameter `transient_pos`.</span>
<span class="sd">    search_rad : type</span>
<span class="sd">        Description of parameter `search_rad`.</span>
<span class="sd">    cosmo : type</span>
<span class="sd">        Description of parameter `cosmo`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>
<span class="sd">    glade_catalog : type</span>
<span class="sd">        Description of parameter `glade_catalog`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">search_rad</span><span class="p">:</span>
        <span class="n">search_rad</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

    <span class="n">rad_deg</span> <span class="o">=</span> <span class="n">search_rad</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ps1cone</span><span class="p">(</span><span class="n">transient_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">transient_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">rad_deg</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="s2">&quot;dr2&quot;</span><span class="p">)</span>

    <span class="n">photoz_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;objID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raMean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;decMean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFKronFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFKronFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFKronFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFKronFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFKronFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFPSFFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFPSFFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFPSFFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFPSFFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFPSFFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFApFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFApFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFApFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFApFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFApFlux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFmeanflxR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFmeanflxR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFmeanflxR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFmeanflxR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFmeanflxR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFmeanflxR6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFmeanflxR6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFmeanflxR6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFmeanflxR6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFmeanflxR6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gFmeanflxR7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rFmeanflxR7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iFmeanflxR7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zFmeanflxR7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yFmeanflxR7&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">result_photoz</span> <span class="o">=</span> <span class="n">ps1cone</span><span class="p">(</span>
        <span class="n">transient_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
        <span class="n">transient_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
        <span class="n">rad_deg</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">photoz_cols</span><span class="p">,</span>
        <span class="n">table</span><span class="o">=</span><span class="s2">&quot;forced_mean&quot;</span><span class="p">,</span>
        <span class="n">release</span><span class="o">=</span><span class="s2">&quot;dr2&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="n">candidate_hosts_pzcols</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">result_photoz</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;objID&quot;</span><span class="p">)</span>
    <span class="n">candidate_hosts_pzcols</span> <span class="o">=</span> <span class="n">candidate_hosts_pzcols</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;objID&quot;</span><span class="p">)</span>
    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">candidate_hosts_pzcols</span><span class="p">,</span> <span class="n">lsuffix</span><span class="o">=</span><span class="s2">&quot;_DROP&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;^(?!.*DROP)&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># no good shape info?</span>
    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentXX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gmomentXX&quot;</span><span class="p">,</span> <span class="s2">&quot;rmomentXX&quot;</span><span class="p">,</span> <span class="s2">&quot;imomentXX&quot;</span><span class="p">,</span> <span class="s2">&quot;zmomentXX&quot;</span><span class="p">,</span> <span class="s2">&quot;ymomentXX&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentYY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gmomentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;rmomentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;imomentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;zmomentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;ymomentYY&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentXY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gmomentXY&quot;</span><span class="p">,</span> <span class="s2">&quot;rmomentXY&quot;</span><span class="p">,</span> <span class="s2">&quot;imomentXY&quot;</span><span class="p">,</span> <span class="s2">&quot;zmomentXY&quot;</span><span class="p">,</span> <span class="s2">&quot;ymomentXY&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;nDetections&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="p">]</span>  <span class="c1"># some VERY basic filtering to say that it&#39;s confidently detected</span>
    <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;primaryDetection&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronRad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gKronRad&quot;</span><span class="p">,</span> <span class="s2">&quot;rKronRad&quot;</span><span class="p">,</span> <span class="s2">&quot;iKronRad&quot;</span><span class="p">,</span> <span class="s2">&quot;zKronRad&quot;</span><span class="p">,</span> <span class="s2">&quot;yKronRad&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronMag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gKronMag&quot;</span><span class="p">,</span> <span class="s2">&quot;rKronMag&quot;</span><span class="p">,</span> <span class="s2">&quot;iKronMag&quot;</span><span class="p">,</span> <span class="s2">&quot;zKronMag&quot;</span><span class="p">,</span> <span class="s2">&quot;yKronMag&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronMagErr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;gKronMagErr&quot;</span><span class="p">,</span> <span class="s2">&quot;rKronMagErr&quot;</span><span class="p">,</span> <span class="s2">&quot;iKronMagErr&quot;</span><span class="p">,</span> <span class="s2">&quot;zKronMagErr&quot;</span><span class="p">,</span> <span class="s2">&quot;yKronMagErr&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
        <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;raMean&quot;</span><span class="p">,</span> <span class="s2">&quot;decMean&quot;</span><span class="p">,</span> <span class="s2">&quot;momentXX&quot;</span><span class="p">,</span> <span class="s2">&quot;momentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;momentYY&quot;</span><span class="p">,</span> <span class="s2">&quot;KronRad&quot;</span><span class="p">,</span> <span class="s2">&quot;KronMag&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">candidate_hosts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">temp_sizes</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronRad&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># temp_sizes[temp_sizes &lt; 0.25] = 0.25 #1 pixel, at least for PS1</span>

    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronRad&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_sizes_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">temp_sizes_std</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>  <span class="c1"># Prevent division by zero</span>

    <span class="c1"># temp_sizes_std[temp_sizes_std != temp_sizes_std] = 0.05*temp_sizes[temp_sizes_std != temp_sizes_std]</span>
    <span class="n">temp_sizes_std</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">[</span><span class="n">temp_sizes_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_sizes</span><span class="p">]</span>

    <span class="n">gal_u</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentXY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">gal_q</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentXX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;momentYY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">gal_u</span><span class="p">,</span> <span class="n">gal_q</span><span class="p">)</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">phi_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0e-10</span><span class="p">,</span> <span class="n">phi_std</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">gal_q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gal_u</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
    <span class="n">a_over_b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">kappa</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kappa</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kappa</span><span class="p">)</span>
    <span class="n">a_over_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a_over_b</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">a_over_b_std</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_over_b</span><span class="p">)</span>  <span class="c1"># uncertainty floor</span>

    <span class="n">galaxies_pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;raMean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;decMean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="p">)</span>

    <span class="n">dlr_samples</span> <span class="o">=</span> <span class="n">calc_dlr</span><span class="p">(</span>
        <span class="n">transient_pos</span><span class="p">,</span>
        <span class="n">galaxies_pos</span><span class="p">,</span>
        <span class="n">temp_sizes</span><span class="p">,</span>
        <span class="n">temp_sizes_std</span><span class="p">,</span>
        <span class="n">a_over_b</span><span class="p">,</span>
        <span class="n">a_over_b_std</span><span class="p">,</span>
        <span class="n">phi</span><span class="p">,</span>
        <span class="n">phi_std</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">temp_mag_r</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronMag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_mag_r_std</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;KronMagErr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># cap at 50% the mag</span>
    <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&gt;</span> <span class="n">temp_mag_r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&gt;</span> <span class="n">temp_mag_r</span><span class="p">]</span>
    <span class="c1"># set a floor of 5%</span>
    <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">temp_mag_r_std</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">temp_mag_r</span><span class="p">]</span>

    <span class="c1"># shred logic</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing panstarrs shreds...&quot;</span><span class="p">)</span>
        <span class="n">shred_idxs</span> <span class="o">=</span> <span class="n">find_panstarrs_shreds</span><span class="p">(</span>
            <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;objID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;raMean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;decMean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">temp_sizes</span><span class="p">,</span>
            <span class="n">temp_sizes_std</span><span class="p">,</span>
            <span class="n">a_over_b</span><span class="p">,</span>
            <span class="n">a_over_b_std</span><span class="p">,</span>
            <span class="n">phi</span><span class="p">,</span>
            <span class="n">phi_std</span><span class="p">,</span>
            <span class="n">temp_mag_r</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shred_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shred_idxs</span><span class="p">)</span><span class="si">}</span><span class="s2"> indices from tentative matches in panstarrs!&quot;</span><span class="p">)</span>
            <span class="n">left_idxs</span> <span class="o">=</span> <span class="o">~</span><span class="n">candidate_hosts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shred_idxs</span><span class="p">)</span>
            <span class="n">candidate_hosts</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="n">left_idxs</span><span class="p">]</span>
            <span class="n">temp_mag_r</span> <span class="o">=</span> <span class="n">temp_mag_r</span><span class="p">[</span><span class="n">left_idxs</span><span class="p">]</span>
            <span class="n">temp_mag_r_std</span> <span class="o">=</span> <span class="n">temp_mag_r_std</span><span class="p">[</span><span class="n">left_idxs</span><span class="p">]</span>
            <span class="n">dlr_samples</span> <span class="o">=</span> <span class="n">dlr_samples</span><span class="p">[</span><span class="n">left_idxs</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">galaxies_pos</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="p">[</span><span class="n">left_idxs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No panstarrs shreds found.&quot;</span><span class="p">)</span>

    <span class="n">n_galaxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_galaxies</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># print(f&quot;No sources found around {transient_name} in Panstarrs DR2!&quot;\</span>
        <span class="c1"># &quot;Double-check that the SN coords overlap the survey footprint.&quot;)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;objID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ls_id&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;offset_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;absmag_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;total_prob&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">galaxies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># get photozs from Andrew Engel&#39;s code!</span>
    <span class="n">default_model_path</span> <span class="o">=</span> <span class="s2">&quot;./MLp_lupton.hdf5&quot;</span>
    <span class="n">default_dust_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

    <span class="n">model</span><span class="p">,</span> <span class="n">range_z</span> <span class="o">=</span> <span class="n">load_lupton_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">default_model_path</span><span class="p">,</span> <span class="n">dust_path</span><span class="o">=</span><span class="n">default_dust_path</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">candidate_hosts</span><span class="p">,</span> <span class="n">PATH</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_dust_path</span><span class="p">,</span> <span class="s2">&quot;sfddata-master&quot;</span><span class="p">))</span>
    <span class="n">posteriors</span><span class="p">,</span> <span class="n">point_estimates</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">range_z</span><span class="p">)</span>
    <span class="n">point_estimates</span><span class="p">[</span><span class="n">point_estimates</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>
    <span class="n">point_estimates</span><span class="p">[</span><span class="n">point_estimates</span> <span class="o">!=</span> <span class="n">point_estimates</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>

    <span class="c1"># 30% uncertainty floor</span>
    <span class="n">err_bool</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">&lt;</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">point_estimates</span>
    <span class="n">errors</span><span class="p">[</span><span class="n">err_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">point_estimates</span><span class="p">[</span><span class="n">err_bool</span><span class="p">]</span>

    <span class="c1"># not QUITE the mean of the posterior, but we&#39;re assuming it&#39;s gaussian :/</span>
    <span class="c1"># TODO -- sample from the full posterior!</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_estimates</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="c1"># if the source is within 1arcsec of a GLADE host, take that spec-z.</span>
    <span class="k">if</span> <span class="n">glade_catalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cross-matching with GLADE for redshifts...&quot;</span><span class="p">)</span>

        <span class="n">glade_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;RAJ2000&quot;</span><span class="p">],</span> <span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;DEJ2000&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">seps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">galaxies_pos</span><span class="p">,</span> <span class="n">glade_coords</span><span class="p">)</span>
        <span class="n">mask_within_1arcsec</span> <span class="o">=</span> <span class="n">seps</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">&lt;</span> <span class="mi">1</span>

        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">][</span><span class="n">mask_within_1arcsec</span><span class="p">]</span> <span class="o">=</span> <span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;z_best&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
            <span class="n">idx</span><span class="p">[</span><span class="n">mask_within_1arcsec</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">][</span><span class="n">mask_within_1arcsec</span><span class="p">]</span> <span class="o">=</span> <span class="n">glade_catalog</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
            <span class="n">idx</span><span class="p">[</span><span class="n">mask_within_1arcsec</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="n">z_best_samples</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_mean&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>  <span class="c1"># Shape (N, 1) to allow broadcasting</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_std&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>  <span class="c1"># Shape (N, 1)</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>  <span class="c1"># Shape (N, M)</span>
    <span class="p">)</span>

    <span class="n">z_best_samples</span><span class="p">[</span><span class="n">z_best_samples</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># set photometric redshift floor</span>

    <span class="n">absmag_samples</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">temp_mag_r</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp_mag_r_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_mag_r</span><span class="p">),</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">distmod</span><span class="p">(</span><span class="n">z_best_samples</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="p">)</span>

    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;objID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_hosts</span><span class="p">[</span><span class="s2">&quot;objID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>

    <span class="c1"># Calculate angular separation between SN and all galaxies (in arcseconds)</span>
    <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;offset_arcsec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">transient_pos</span><span class="p">)</span><span class="o">.</span><span class="n">arcsec</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">):</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;z_best_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_best_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;dlr_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlr_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">galaxies</span><span class="p">[</span><span class="s2">&quot;absmag_samples&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">absmag_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">galaxies</span></div>



<div class="viewcode-block" id="calc_dlr">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.calc_dlr">[docs]</a>
<span class="k">def</span> <span class="nf">calc_dlr</span><span class="p">(</span><span class="n">transient_pos</span><span class="p">,</span> <span class="n">galaxies_pos</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a_std</span><span class="p">,</span> <span class="n">a_over_b</span><span class="p">,</span> <span class="n">a_over_b_std</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">phi_std</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transient_pos : type</span>
<span class="sd">        Description of parameter `transient_pos`.</span>
<span class="sd">    galaxies_pos : type</span>
<span class="sd">        Description of parameter `galaxies_pos`.</span>
<span class="sd">    a : type</span>
<span class="sd">        Description of parameter `a`.</span>
<span class="sd">    a_std : type</span>
<span class="sd">        Description of parameter `a_std`.</span>
<span class="sd">    a_over_b : type</span>
<span class="sd">        Description of parameter `a_over_b`.</span>
<span class="sd">    a_over_b_std : type</span>
<span class="sd">        Description of parameter `a_over_b_std`.</span>
<span class="sd">    phi : type</span>
<span class="sd">        Description of parameter `phi`.</span>
<span class="sd">    phi_std : type</span>
<span class="sd">        Description of parameter `phi_std`.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Description of parameter `n_samples`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_gals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">galaxies_pos</span><span class="p">)</span>

    <span class="n">transient_ra</span> <span class="o">=</span> <span class="n">transient_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">transient_dec</span> <span class="o">=</span> <span class="n">transient_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>

    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># TODO -- incorporate uncertainty in galaxy and transient position</span>
        <span class="n">hosts_ra</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">hosts_dec</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">a_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
        <span class="n">a_over_b</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">a_over_b</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">a_over_b_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">phi</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">phi_std</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_gals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hosts_ra</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">hosts_dec</span> <span class="o">=</span> <span class="n">galaxies_pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>

    <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="n">transient_ra</span> <span class="o">-</span> <span class="n">hosts_ra</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="p">(</span><span class="n">transient_dec</span> <span class="o">-</span> <span class="n">hosts_dec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>

    <span class="n">gam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">-</span> <span class="n">gam</span>

    <span class="n">dlr</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">a_over_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dlr</span></div>



<div class="viewcode-block" id="find_panstarrs_shreds">
<a class="viewcode-back" href="../../autoapi/astro_prost/helpers/index.html#astro_prost.helpers.find_panstarrs_shreds">[docs]</a>
<span class="k">def</span> <span class="nf">find_panstarrs_shreds</span><span class="p">(</span>
    <span class="n">objids</span><span class="p">,</span>
    <span class="n">ra_allgals</span><span class="p">,</span>
    <span class="n">dec_allgals</span><span class="p">,</span>
    <span class="n">size</span><span class="p">,</span>
    <span class="n">size_std</span><span class="p">,</span>
    <span class="n">a_over_b</span><span class="p">,</span>
    <span class="n">a_over_b_std</span><span class="p">,</span>
    <span class="n">phi</span><span class="p">,</span>
    <span class="n">phi_std</span><span class="p">,</span>
    <span class="n">appmag</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Short summary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objids : type</span>
<span class="sd">        Description of parameter `objids`.</span>
<span class="sd">    ra_allgals : type</span>
<span class="sd">        Description of parameter `ra_allgals`.</span>
<span class="sd">    dec_allgals : type</span>
<span class="sd">        Description of parameter `dec_allgals`.</span>
<span class="sd">    size : type</span>
<span class="sd">        Description of parameter `size`.</span>
<span class="sd">    size_std : type</span>
<span class="sd">        Description of parameter `size_std`.</span>
<span class="sd">    a_over_b : type</span>
<span class="sd">        Description of parameter `a_over_b`.</span>
<span class="sd">    a_over_b_std : type</span>
<span class="sd">        Description of parameter `a_over_b_std`.</span>
<span class="sd">    phi : type</span>
<span class="sd">        Description of parameter `phi`.</span>
<span class="sd">    phi_std : type</span>
<span class="sd">        Description of parameter `phi_std`.</span>
<span class="sd">    appmag : type</span>
<span class="sd">        Description of parameter `appmag`.</span>
<span class="sd">    verbose : type</span>
<span class="sd">        Description of parameter `verbose`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>
<span class="sd">        Description of returned object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># deprecated for now!</span>
    <span class="n">dropidxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_allgals</span><span class="p">)):</span>
        <span class="n">onegal_objid</span> <span class="o">=</span> <span class="n">objids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">onegal_ra</span> <span class="o">=</span> <span class="n">ra_allgals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">onegal_dec</span> <span class="o">=</span> <span class="n">dec_allgals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">onegal_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">onegal_ra</span><span class="p">,</span> <span class="n">onegal_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="n">restgal_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ra_allgals</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dec_allgals</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a_over_b</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_ab_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">a_over_b_std</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_phi_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">phi_std</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_size_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">size_std</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">restgal_appmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">appmag</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">restgal_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">restgal_ra</span><span class="p">,</span> <span class="n">restgal_dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="n">dlr</span> <span class="o">=</span> <span class="n">calc_dlr</span><span class="p">(</span>
            <span class="n">onegal_coord</span><span class="p">,</span>
            <span class="n">restgal_coord</span><span class="p">,</span>
            <span class="n">restgal_size</span><span class="p">,</span>
            <span class="n">restgal_size_std</span><span class="p">,</span>
            <span class="n">restgal_ab</span><span class="p">,</span>
            <span class="n">restgal_ab_std</span><span class="p">,</span>
            <span class="n">restgal_phi</span><span class="p">,</span>
            <span class="n">restgal_phi_std</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">seps</span> <span class="o">=</span> <span class="n">onegal_coord</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">restgal_coord</span><span class="p">)</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">seps</span> <span class="o">/</span> <span class="n">dlr</span><span class="p">)</span>

        <span class="c1"># if within the dlr of another galaxy, remove dimmer galaxy</span>
        <span class="n">original_min_idx</span> <span class="o">=</span> <span class="n">min_idx</span> <span class="k">if</span> <span class="n">min_idx</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="k">else</span> <span class="n">min_idx</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Considering source at: </span><span class="si">{</span><span class="n">onegal_ra</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">onegal_dec</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Next-closest galaxy (by fractional offset):&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restgal_coord</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">restgal_coord</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size of this nearby galaxy:</span><span class="si">{</span><span class="n">restgal_size</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size uncertainty of this nearby galaxy:</span><span class="si">{</span><span class="n">restgal_size_std</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Axis ratio:&quot;</span><span class="p">,</span> <span class="n">restgal_ab</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Axis ratio uncertainty:&quot;</span><span class="p">,</span> <span class="n">restgal_ab_std</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phi:&quot;</span><span class="p">,</span> <span class="n">restgal_phi</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phi uncertainty:&quot;</span><span class="p">,</span> <span class="n">restgal_phi_std</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Angular offset (arcsec):&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">seps</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fractional separation:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">seps</span> <span class="o">/</span> <span class="n">dlr</span><span class="p">))</span>

        <span class="c1"># If within the dlr of another galaxy, remove the dimmer galaxy</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seps</span> <span class="o">/</span> <span class="n">dlr</span><span class="p">)[</span><span class="n">min_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restgal_appmag</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">appmag</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="c1"># The current galaxy is dimmer</span>
                <span class="c1"># (meaning the other galaxy is brighter AND</span>
                <span class="c1"># has a dlr that contains this galaxy), drop it</span>
                <span class="n">dropidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropping objID </span><span class="si">{</span><span class="n">onegal_objid</span><span class="si">}</span><span class="s2"> with ra, dec= </span><span class="si">{</span><span class="n">onegal_ra</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">onegal_dec</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dropidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_min_idx</span><span class="p">)</span>
                <span class="c1"># The other galaxy is dimmer, drop it</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Dropping objID </span><span class="si">{</span><span class="n">objids</span><span class="p">[</span><span class="n">original_min_idx</span><span class="p">]</span><span class="si">}</span><span class="s2"> with&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;ra, dec = </span><span class="si">{</span><span class="n">ra_allgals</span><span class="p">[</span><span class="n">original_min_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dec_allgals</span><span class="p">[</span><span class="n">original_min_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dropidxs</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Alex Gagliano.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>